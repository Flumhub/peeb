name: Deploy Peeb Bot

on:
  push:
    branches: [ main, master, feature ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          cd /opt/peeb
          echo "â¹ï¸ Stopping bot service..."
          systemctl stop peeb-bot
          
          echo "ğŸ’¾ Backing up config files..."
          # Create backup directory with timestamp
          BACKUP_DIR="/opt/peeb/backup_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          
          # Backup all config and data files
          [ -f "aliases.json" ] && cp aliases.json "$BACKUP_DIR/"
          [ -f "reactions.json" ] && cp reactions.json "$BACKUP_DIR/"
          [ -f "reminders.json" ] && cp reminders.json "$BACKUP_DIR/"
          [ -f "appsettings.json" ] && cp appsettings.json "$BACKUP_DIR/"
          
          # Backup reactions folder
          [ -d "reactions" ] && cp -r reactions "$BACKUP_DIR/"
          
          # Save config files to temp location OUTSIDE the repo
          mkdir -p /tmp/peeb_backup
          [ -f "aliases.json" ] && cp aliases.json /tmp/peeb_backup/
          [ -f "reactions.json" ] && cp reactions.json /tmp/peeb_backup/
          [ -f "reminders.json" ] && cp reminders.json /tmp/peeb_backup/
          [ -f "appsettings.json" ] && cp appsettings.json /tmp/peeb_backup/
          [ -d "reactions" ] && cp -r reactions /tmp/peeb_backup/
          
          echo "ğŸ“¥ Pulling latest changes..."
          git reset --hard HEAD
          git clean -fd
          git pull origin main
          
          echo "ğŸ”„ Restoring config files..."
          # Restore from temp location
          [ -f "/tmp/peeb_backup/aliases.json" ] && cp /tmp/peeb_backup/aliases.json ./
          [ -f "/tmp/peeb_backup/reactions.json" ] && cp /tmp/peeb_backup/reactions.json ./
          [ -f "/tmp/peeb_backup/reminders.json" ] && cp /tmp/peeb_backup/reminders.json ./
          [ -f "/tmp/peeb_backup/appsettings.json" ] && cp /tmp/peeb_backup/appsettings.json ./
          [ -d "/tmp/peeb_backup/reactions" ] && cp -r /tmp/peeb_backup/reactions ./
          
          # Cleanup temp backup
          rm -rf /tmp/peeb_backup
          
          echo "ğŸ§¹ Cleaning up old backups (keep last 5)..."
          cd /opt/peeb && ls -dt backup_*/ 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
          
          echo "ğŸ”¨ Building project..."
          dotnet build -c Release
          
          echo "â–¶ï¸ Starting bot service..."
          systemctl start peeb-bot
          echo "âœ… Deployment complete!"
          sleep 3
          systemctl is-active peeb-bot
          echo "ğŸ‰ Peeb is now running the latest version with preserved config!"