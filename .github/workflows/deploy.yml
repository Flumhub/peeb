name: Deploy Peeb Bot

on:
  push:
    branches: [ main, master, feature ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          cd /opt/peeb
          echo "â¹ï¸ Stopping bot service..."
          systemctl stop peeb-bot
          
          echo "ğŸ’¾ Backing up config files..."
          # Create backup directory with timestamp
          BACKUP_DIR="/opt/peeb/backup_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          
          # Backup config files if they exist
          [ -f "aliases.json" ] && cp aliases.json "$BACKUP_DIR/"
          [ -f "reactions.json" ] && cp reactions.json "$BACKUP_DIR/"
          [ -f "reminders.json" ] && cp reminders.json "$BACKUP_DIR/"
          [ -f "appsettings.json" ] && cp appsettings.json "$BACKUP_DIR/"
          
          # Also create quick restore copies
          [ -f "aliases.json" ] && cp aliases.json aliases.json.restore
          [ -f "reactions.json" ] && cp reactions.json reactions.json.restore
          [ -f "reminders.json" ] && cp reminders.json reminders.json.restore
          [ -f "appsettings.json" ] && cp appsettings.json appsettings.json.restore
          
          echo "ğŸ“¥ Pulling latest changes..."
          git reset --hard HEAD
          git clean -fd
          git pull origin main
          
          echo "ğŸ”„ Restoring config files..."
          # Restore config files if backups exist
          [ -f "aliases.json.restore" ] && mv aliases.json.restore aliases.json
          [ -f "reactions.json.restore" ] && mv reactions.json.restore reactions.json
          [ -f "reminders.json.restore" ] && mv reminders.json.restore reminders.json
          [ -f "appsettings.json.restore" ] && mv appsettings.json.restore appsettings.json
          
          echo "ğŸ§¹ Cleaning up old backups (keep last 5)..."
          ls -t backup_* 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
          
          echo "ğŸ”¨ Building project..."
          dotnet build -c Release
          
          echo "â–¶ï¸ Starting bot service..."
          systemctl start peeb-bot
          echo "âœ… Deployment complete!"
          sleep 3
          systemctl is-active peeb-bot
          echo "ğŸ‰ Peeb is now running the latest version with preserved config!"